import{createWriteStream as F,existsSync as L,mkdirSync as j}from"node:fs";import{dirname as W}from"node:path";import{Readable as B}from"node:stream";import{finished as I}from"node:stream/promises";function K(t,e){if(e instanceof Response){if(e.body===null)throw new Error(`Cannot write a response with no body to ${t}`);let r=W(t);if(!L(r))j(r,{recursive:!0});return I(B.fromWeb(e.body).pipe(F(t,{flags:"w"}))).then(()=>0)}throw new Error(`Write Not implemented for ${e}`)}var g={write:K};function b(){return process.versions.bun!==void 0}if(!b())globalThis.Bun=g;import{existsSync as Q}from"node:fs";import{match as X}from"ts-pattern";function V(t,e){if(!e.startsWith("."))e=`.${e}`;if(!t.endsWith(e))return`${t}${e}`;return t}function f(t){return Object.fromEntries(Object.entries(t).filter(([,e])=>e!==void 0))}function v(t){return q().then((e)=>Y(t,e))}function Y(t,e){return[t,e].join("&")}async function q(){return await(await fetch("https://apkcombo.app/checkin")).text()}import{load as G}from"cheerio";import{match as J}from"ts-pattern";function m(t){return t!==null}var w={apk:"apk",bundle:"bundle"},O=["latest","stable","beta","alpha"],P=["armeabi-v7a","arm64-v8a","x86","x86_64"];function l(t){if(t.startsWith("https://"))return t;if(t.startsWith("/"))return`https://apkcombo.app${t}`;return`https://apkcombo.app/${t}`}function T({org:t,repo:e}){return l(`/${t}/${e}/old-versions`)}function S({org:t,repo:e},r){return l(`${t}/${e}/download/phone-${r}-apk`)}function k(t){if(t.headers.has("Content-Disposition")){let r=t.headers.get("Content-Disposition").split("filename=")[1];return JSON.parse(r)}}function E(t){return O.includes(t)}function y(t){return P.every((e)=>t.arch.includes(e))||t.arch.includes("universal")||t.arch.includes("noarch")}function U(t){return t.name.toLowerCase().includes("alpha")}function $(t){return t.name.toLowerCase().includes("beta")}function D(t){return!t.name.toLowerCase().includes("alpha")&&!t.name.toLowerCase().includes("beta")}class d extends Error{}function C(t){return fetch(t).then((e)=>{if(e.redirected)throw new d(e.url);return e.text()}).then(z)}function z(t){let e=G(t);return e("#best-variant-tab").children().toArray().map((s)=>{let i=e(s),n=i.find(".vername").text(),o=J(i.find("span").text().trim()).when((x)=>x.includes("APK"),()=>w.apk).when((x)=>x.includes("BUNDLE"),()=>w.bundle).otherwise(()=>"unknown"),p=i.find(".blur").text().trim().split(", "),h=i.find(".spec").eq(1).text(),A=i.find(".spec").eq(2).text().trim(),a=i.find("a").attr("href");if(!a)return null;return{version:n,type:o,arch:p,minAndroidVersion:h,dpi:A,url:l(a)}}).filter(m)}import{load as H}from"cheerio";function N(t){return fetch(t).then((e)=>e.text()).then(M)}function M(t){let e=H(t);return e(".list-versions").children().toArray().map((s)=>{let i=e(s),n=i.find(".vername").text(),o=i.find("a").attr("href");if(!n||!o)return null;return{name:n,url:l(o)}}).filter(m)}var R={type:"apk",version:"stable",arch:"universal",dpi:"nodpi",overwrite:!0};class _{#t;constructor(t={}){this.#t=f(t)}download(t,e={}){let r={...R,...this.#t,...f(e)};return _.download(t,r)}static async download(t,e={}){let r={...R,...f(e)},c;if(E(r.version)){let n=T(t),o=await N(n),p=X(r.version).with("latest",()=>o[0]).with("beta",()=>o.find($)).with("alpha",()=>o.find(U)).otherwise(()=>o.find(D));if(!p)throw new Error(`Could not find any suitable ${r.version} version`);c=p.url,console.log(`Downloading ${p.name}...`)}else c=S(t,r.version),console.log(`Downloading ${t.repo} ${r.version}...`);if(!c)throw new Error("Could not find any suitable version");let u=await C(c).then((n)=>({redirected:!1,variants:n})).catch((n)=>{if(n instanceof d)return{redirected:!0,url:n.message,variants:null};throw n}),s=null;if(u.redirected)console.warn("[WARNING]",`Only single variant is supported for ${t.org}/${t.repo}`),s={url:u.url};else{let n=u.variants;if(r.arch!=="universal"&&r.arch!=="noarch")n=n.find((o)=>o.arch.includes(r.arch))?n.filter((o)=>o.arch.includes(r.arch)):n.filter(y);else n=n.filter(y);if(r.dpi!=="*"&&r.dpi!=="any")n=n.filter((o)=>o.dpi===r.dpi);if(r.minAndroidVersion)n=n.filter((o)=>parseFloat(o.minAndroidVersion)<=parseFloat(r.minAndroidVersion));n=n.filter((o)=>o.type===r.type),s=n[0]}if(!s)throw new Error("Could not find any suitable variant");let i=await v(s.url);return fetch(i).then(async(n)=>{let o=k(n),p=o.split(".").pop(),h=r.outDir??".",A=V(r.outFile??o,p),a=`${h}/${A}`;if(!r.overwrite&&Q(a))return{dest:a,skipped:!0};return await Bun.write(a,n),{dest:a,skipped:!1}})}}export{_ as APKComboDownloader};

//# debugId=B5E4A260CD6445FC64756E2164756E21
